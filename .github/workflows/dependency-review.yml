name: 📦 Dependency Review

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: 🔍 Review Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔍 Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure
          deny-licenses: GPL-2.0, GPL-3.0

      - name: 📊 Comment on dependency changes
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const comment = `🚨 **Dependency Review Failed**

            This pull request introduces dependencies that don't meet our security or licensing requirements.

            **Common issues:**
            - High/Critical severity vulnerabilities
            - Incompatible licenses (GPL-2.0, GPL-3.0)
            - Dependencies with known security issues

            **Next steps:**
            1. Review the dependency review results above
            2. Update or remove problematic dependencies
            3. Consider alternative packages if needed

            **Need help?** Check our [Contributing Guidelines](https://github.com/northenfreyja/NellyBot/blob/master/CONTRIBUTING.md) for dependency management best practices.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });